<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>도담마루 출석 체크</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        '2xl': '1536px',
                        '3xl': '1920px',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-secondary {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-text-delete {
            color: #ef4444; /* red-500 */
        }
        .btn-text-delete:hover {
            text-decoration: underline;
        }
        /* Custom styles for circular button */
        .circular-btn {
            width: 48px; /* w-12, Adjusted for smaller grid */
            height: 48px; /* h-12, Adjusted for smaller grid */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600; /* font-semibold */
            font-size: 0.75rem; /* text-xs, Adjusted for smaller grid */
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            color: white; /* Text color for the button */
        }
        .circular-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .circular-btn:disabled {
            background-color: #9ca3af; /* gray-400 for disabled state */
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-stone-100 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-full bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-4">
        
        <!-- Date Display Section -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 text-stone-600">
            <div class="text-center sm:text-left mb-2 sm:mb-0">
                <p class="font-bold text-green-500 text-[70px]">도서 대출일</p>
                <div id="current-date" class="font-medium text-green-500 text-3xl sm:text-4xl lg:text-[75px] leading-none"></div>
            </div>
            <div class="text-center sm:text-right">
                <p class="font-bold text-orange-500 text-[70px]">도서 반납일</p>
                <div id="two-weeks-later-date" class="font-medium text-orange-500 text-3xl sm:text-4xl lg:text-[75px] leading-none"></div>
            </div>
        </div>

        <!-- Separator Line -->
        <div class="h-px bg-stone-300 my-4"></div>

        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-stone-800">도담마루 출석 체크 🧑‍🎓</h1>
            <p class="text-stone-500 mt-2">자기 이름을 찾아 클릭 해 주세요!</p>
        </header>

        <!-- Student List -->
        <section class="space-y-4">
            <h2 class="text-lg font-semibold text-stone-700 mb-2">학생 목록 (총 <span id="student-count">0</span>명)</h2>
            <div id="student-list-container" class="bg-white border border-stone-200 rounded-lg p-3 shadow-sm grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-9 3xl:grid-cols-11 gap-x-2 gap-y-1">
                <p id="no-students-message" class="col-span-full text-center text-stone-400 mt-4 hidden">아직 등록된 학생이 없어요.</p>
                <!-- 학생 카드가 여기에 동적으로 추가됩니다 -->
            </div>
        </section>

        <footer class="text-center pt-2 flex flex-row justify-center items-center gap-4">
            <button id="reset-all-button" class="text-sm btn-text-delete hover:underline">
                모든 학생 기록 초기화
            </button>
            <button id="view-all-history-button" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">
                전체 학생 기록 보기
            </button>
        </footer>

    </main>

    <!-- 모든 학생 기록 초기화 코드 입력 모달 (최종 확인 기능 통합) -->
    <div id="code-reset-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-stone-800">정말 모든 학생을 초기화하시겠어요?</h3>
            <p class="text-stone-500 mt-2 mb-4">초기화하려면 4자리 코드를 입력하세요. <br>이 작업은 되돌릴 수 없습니다.</p>
            <input type="password" id="reset-code-input" class="w-full p-2 border-2 border-stone-300 rounded-md text-center text-lg tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="4">
            <p id="code-error-message" class="text-red-500 text-sm mt-2 hidden">올바른 코드를 입력해주세요.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="confirm-code-button" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">확인</button>
                <button id="cancel-code-button" class="px-6 py-2 rounded-lg font-semibold bg-stone-200 text-stone-700 hover:bg-stone-300">취소</button>
            </div>
        </div>
    </div>

    <!-- 정보 메시지 모달 (예: 40명 제한, 이름 중복) -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 id="info-modal-title" class="text-xl font-bold text-stone-800">알림</h3>
            <p id="info-modal-text" class="text-stone-500 mt-2 mb-6">[메시지 내용]</p>
            <button id="close-info-modal-button" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white">확인</button>
        </div>
    </div>

    <!-- 학생 전체 출석 기록 막대 그래프 모달 -->
    <div id="all-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl text-center">
            <h3 id="all-history-modal-title" class="text-xl font-bold text-stone-800 mb-4">전체 학생 이번 달 출석 기록</h3>
            <div class="w-full h-[50vh] bg-stone-50 border border-stone-200 rounded-lg p-3">
                <canvas id="attendance-chart"></canvas>
            </div>
            <button id="close-all-history-modal-button" class="mt-6 px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">닫기</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const studentListContainer = document.getElementById('student-list-container');
            const studentCountSpan = document.getElementById('student-count');
            const noStudentsMessage = document.getElementById('no-students-message');
            const resetAllButton = document.getElementById('reset-all-button');
            const viewAllHistoryButton = document.getElementById('view-all-history-button');

            const codeResetModal = document.getElementById('code-reset-modal');
            const resetCodeInput = document.getElementById('reset-code-input');
            const confirmCodeButton = document.getElementById('confirm-code-button');
            const cancelCodeButton = document.getElementById('cancel-code-button');
            const codeErrorMessage = document.getElementById('code-error-message');

            const infoModal = document.getElementById('info-modal');
            const infoModalTitle = document.getElementById('info-modal-title');
            const infoModalText = document.getElementById('info-modal-text');
            const closeInfoModalButton = document.getElementById('close-info-modal-button');
            
            const allHistoryModal = document.getElementById('all-history-modal');
            const closeAllHistoryModalButton = document.getElementById('close-all-history-modal-button');
            const attendanceChartCanvas = document.getElementById('attendance-chart');

            const currentDateEl = document.getElementById('current-date');
            const twoWeeksLaterDateEl = document.getElementById('two-weeks-later-date');

            let students = {};
            let studentOrder = [];
            let draggedStudentName = null;
            let myChart = null; // Chart.js 인스턴스를 저장할 변수

            const fixedStudentNames = [
                '정해나', '원소정', '우찬영', '전제준', '강한봄', '이기웅', '용해인', '이효율',
                '장설', '이하윤', '곽재은', '김태이', '강시호', '정모세', '김도희', '김라엘',
                '이기백', '이건우', '김다인', '김도준', '신지우', '한재이', '신수빈', '박지유',
                '권도연', '우예빈', '김도훈', '차태호', '박경민', '권나윤', '강한아'
            ];

            const studentCardColors = [
                'bg-blue-50', 'bg-green-50', 'bg-yellow-50', 'bg-red-50',
                'bg-purple-50', 'bg-pink-50', 'bg-indigo-50', 'bg-teal-50',
            ];

            const circularButtonColors = [
                'bg-blue-600', 'bg-green-600', 'bg-yellow-600', 'bg-red-600',
                'bg-purple-600', 'bg-pink-600', 'bg-indigo-600', 'bg-teal-600',
            ];

            const getFormattedDateString = (date, includeYear = true, includeTime = false) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];
                const dayOfWeek = daysOfWeek[date.getDay()];
                
                let dateString = '';
                if (includeYear) {
                    dateString += `${year}년 `;
                }
                dateString += `${month}월 ${day}일 (${dayOfWeek})`;

                if (includeTime) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    dateString += ` ${hours}시 ${minutes}분 ${seconds}초`;
                }
                return dateString;
            };

            const getReturnDate = () => {
                let date = new Date();
                date.setDate(date.getDate() + 14);

                let dayOfWeek = date.getDay();
                if (dayOfWeek === 0) {
                    date.setDate(date.getDate() + 1);
                } else if (dayOfWeek === 6) {
                    date.setDate(date.getDate() + 2);
                }
                return getFormattedDateString(date, false);
            };

            const loadData = () => {
                const savedData = localStorage.getItem('attendanceAppStudents');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    students = parsedData.students || {};
                    studentOrder = parsedData.studentOrder || [...fixedStudentNames];
                } else {
                    studentOrder = [...fixedStudentNames];
                    fixedStudentNames.forEach(name => {
                        students[name] = { attendanceDates: [] };
                    });
                }
                const currentStudentNamesInOrder = new Set(studentOrder);
                const studentsToDelete = Object.keys(students).filter(name => !currentStudentNamesInOrder.has(name));
                studentsToDelete.forEach(name => delete students[name]);

                fixedStudentNames.forEach(name => {
                    if (!students[name]) {
                        students[name] = { attendanceDates: [] };
                    }
                });
                studentOrder = studentOrder.filter(name => fixedStudentNames.includes(name));
                fixedStudentNames.forEach(name => {
                    if (!studentOrder.includes(name)) {
                        studentOrder.push(name);
                    }
                });
            };

            const saveData = () => {
                const dataToSave = {
                    students: students,
                    studentOrder: studentOrder,
                };
                localStorage.setItem('attendanceAppStudents', JSON.stringify(dataToSave));
            };

            const showInfoModal = (title, message) => {
                infoModalTitle.textContent = title;
                infoModalText.textContent = message;
                infoModal.classList.remove('hidden');
            };

            const renderStudents = () => {
                studentListContainer.innerHTML = '';
                studentCountSpan.textContent = studentOrder.length;

                if (studentOrder.length === 0) {
                    noStudentsMessage.classList.remove('hidden');
                    noStudentsMessage.className = 'col-span-full text-center text-stone-400 mt-4';
                    studentListContainer.appendChild(noStudentsMessage);
                } else {
                    noStudentsMessage.classList.add('hidden');
                }

                const currentMonthYear = new Date().getFullYear() + '년 ' + String(new Date().getMonth() + 1).padStart(2, '0') + '월';
                
                const monthlyAttendanceCounts = studentOrder.map(studentName => {
                    const student = students[studentName];
                    const uniqueMonthlyAttendanceDates = new Set(
                        student.attendanceDates
                            .filter(date => date.startsWith(currentMonthYear))
                            .map(date => date.split(' (')[0])
                    );
                    return { name: studentName, count: uniqueMonthlyAttendanceDates.size };
                });

                monthlyAttendanceCounts.sort((a, b) => b.count - a.count);

                let top3Students = new Set();
                if (monthlyAttendanceCounts.length > 0) {
                    top3Students.add(monthlyAttendanceCounts[0].name);
                    if (monthlyAttendanceCounts.length > 1 && monthlyAttendanceCounts[1].count === monthlyAttendanceCounts[0].count) {
                        top3Students.add(monthlyAttendanceCounts[1].name);
                    } else if (monthlyAttendanceCounts.length > 1) {
                        top3Students.add(monthlyAttendanceCounts[1].name);
                    }
                    if (monthlyAttendanceCounts.length > 2 && monthlyAttendanceCounts[2].count === monthlyAttendanceCounts[1].count) {
                        top3Students.add(monthlyAttendanceCounts[2].name);
                    } else if (monthlyAttendanceCounts.length > 2 && monthlyAttendanceCounts[2].count === monthlyAttendanceCounts[0].count) {
                         top3Students.add(monthlyAttendanceCounts[2].name);
                    } else if (monthlyAttendanceCounts.length > 2 && monthlyAttendanceCounts[2].count < monthlyAttendanceCounts[1].count) {
                        top3Students.add(monthlyAttendanceCounts[2].name);
                    }
                }
                
                studentOrder.forEach((studentName, index) => {
                    const student = students[studentName];
                    if (!student) {
                        students[studentName] = { attendanceDates: [] };
                    }

                    const uniqueMonthlyAttendanceDates = new Set(
                        student.attendanceDates
                            .filter(date => date.startsWith(currentMonthYear))
                            .map(date => date.split(' (')[0])
                    );
                    const attendedCount = uniqueMonthlyAttendanceDates.size; 

                    const todayDateOnly = getFormattedDateString(new Date(), true, false).split(' (')[0];
                    const hasAttendedToday = student.attendanceDates.some(date => date.startsWith(todayDateOnly));

                    const cardColorClass = studentCardColors[index % studentCardColors.length];
                    const buttonColorClass = circularButtonColors[index % circularButtonColors.length];

                    const isTopStudent = top3Students.has(studentName);
                    const crownIcon = isTopStudent ? ' 👑' : '';

                    const studentCard = document.createElement('div');
                    studentCard.className = `${cardColorClass} p-2 rounded-lg border border-stone-200 shadow-sm flex flex-col items-center justify-between cursor-grab`;
                    studentCard.setAttribute('data-student-name', studentName);
                    studentCard.setAttribute('draggable', 'true');

                    studentCard.innerHTML = `
                        <div class="flex items-center justify-between w-full mb-3">
                            <h3 class="text-2xl font-semibold text-stone-800 truncate pr-2">${studentName}${crownIcon}</h3>
                        </div>
                        <div class="flex flex-col items-center space-y-2">
                            <button class="circular-btn attend-btn ${hasAttendedToday ? 'bg-gray-400 cursor-not-allowed' : buttonColorClass}" ${hasAttendedToday ? 'disabled' : ''} data-student-name="${studentName}">
                                ${hasAttendedToday ? '완료! 🎉' : '출석'}
                            </button>
                            <div class="text-center text-base mt-2">
                                <p class="text-stone-500 text-sm">이번 달 출석 횟수</p>
                                <p class="text-xl font-bold text-blue-600">${attendedCount}회</p>
                                ${hasAttendedToday ? `<button class="text-sm text-blue-500 hover:text-blue-700 hover:underline undo-attend-btn mt-1" data-student-name="${studentName}">되돌리기</button>` : ''}
                            </div>
                        </div>
                    `;
                    studentListContainer.appendChild(studentCard);
                });

                attachStudentButtonListeners();
                attachDragAndDropListeners();
            };

            const attachStudentButtonListeners = () => {
                document.querySelectorAll('.attend-btn').forEach(button => {
                    button.onclick = (event) => {
                        const studentName = event.target.dataset.studentName;
                        const fullTodayStrWithTime = getFormattedDateString(new Date(), true, true);
                        const todayDateOnly = getFormattedDateString(new Date(), true, false).split(' (')[0];
                        
                        if (students[studentName]) {
                            const hasAttendedToday = students[studentName].attendanceDates.some(date => date.startsWith(todayDateOnly));

                            if (hasAttendedToday) {
                                showInfoModal('이미 출석 완료', '이 학생은 오늘 이미 출석했습니다.');
                                return;
                            }

                            students[studentName].attendanceDates.push(fullTodayStrWithTime);
                            saveData();
                            renderStudents();
                        }
                    };
                });
                
                document.querySelectorAll('.undo-attend-btn').forEach(button => {
                    button.onclick = (event) => {
                        const studentName = event.target.dataset.studentName;
                        const todayDateOnly = getFormattedDateString(new Date(), true, false).split(' (')[0];

                        if (students[studentName]) {
                            let lastIndex = -1;
                            for (let i = students[studentName].attendanceDates.length - 1; i >= 0; i--) {
                                if (students[studentName].attendanceDates[i].startsWith(todayDateOnly)) {
                                    lastIndex = i;
                                    break;
                                }
                            }
                            
                            if (lastIndex > -1) {
                                students[studentName].attendanceDates.splice(lastIndex, 1);
                                saveData();
                                renderStudents();
                            }
                        }
                    };
                });
            };

            const attachDragAndDropListeners = () => {
                const studentCards = studentListContainer.querySelectorAll('[draggable="true"]');

                studentCards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        draggedStudentName = card.dataset.studentName;
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', draggedStudentName);
                        setTimeout(() => {
                            card.classList.add('opacity-50', 'border-dashed', 'border-blue-500');
                        }, 0);
                    });

                    card.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        const targetCard = e.currentTarget;
                        if (draggedStudentName !== targetCard.dataset.studentName) {
                            targetCard.classList.add('border-2', 'border-blue-300', 'scale-105');
                        }
                    });

                    card.addEventListener('dragleave', (e) => {
                        e.currentTarget.classList.remove('border-2', 'border-blue-300', 'scale-105');
                    });

                    card.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const droppedOnStudentName = e.currentTarget.dataset.studentName;

                        if (draggedStudentName && droppedOnStudentName && draggedStudentName !== droppedOnStudentName) {
                            const fromIndex = studentOrder.indexOf(draggedStudentName);
                            const toIndex = studentOrder.indexOf(droppedOnStudentName);

                            if (fromIndex > -1 && toIndex > -1) {
                                const [movedItem] = studentOrder.splice(fromIndex, 1);
                                studentOrder.splice(toIndex, 0, movedItem);
                                saveData();
                                renderStudents();
                            }
                        }
                    });

                    card.addEventListener('dragend', (e) => {
                        studentCards.forEach(c => c.classList.remove('opacity-50', 'border-dashed', 'border-blue-500', 'border-2', 'border-blue-300', 'scale-105'));
                        draggedStudentName = null;
                    });
                });
            };
            
            const renderChart = () => {
                const currentMonthYear = new Date().getFullYear() + '년 ' + String(new Date().getMonth() + 1).padStart(2, '0') + '월';
                const chartData = studentOrder.map(name => {
                    const student = students[name];
                    const uniqueMonthlyAttendanceDates = new Set(
                        student.attendanceDates
                            .filter(date => date.startsWith(currentMonthYear))
                            .map(date => date.split(' (')[0])
                    );
                    return {
                        name: name,
                        count: uniqueMonthlyAttendanceDates.size
                    };
                }).sort((a, b) => b.count - a.count);

                const labels = chartData.map(d => d.name);
                const data = chartData.map(d => d.count);
                const backgroundColors = data.map((count, index) => {
                    const studentIndex = studentOrder.indexOf(chartData[index].name);
                    const colorClass = circularButtonColors[studentIndex % circularButtonColors.length];
                    return colorClass.replace('bg-', '#').replace('600', '700'); // Use a slightly darker color for the bar
                });
                
                if (myChart) {
                    myChart.destroy();
                }

                myChart = new Chart(attendanceChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '이번 달 출석 횟수',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('700', '800')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: '이번 달 학생 출석 기록',
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '출석 횟수'
                                }
                            }
                        }
                    }
                });
            };

            // Event Listeners
            resetAllButton.addEventListener('click', () => {
                codeResetModal.classList.remove('hidden');
                resetCodeInput.value = '';
                codeErrorMessage.classList.add('hidden');
            });

            confirmCodeButton.addEventListener('click', () => {
                const enteredCode = resetCodeInput.value;
                if (enteredCode === '6408') {
                    students = {};
                    studentOrder = [...fixedStudentNames];
                    fixedStudentNames.forEach(name => {
                        students[name] = { attendanceDates: [] };
                    });
                    saveData();
                    renderStudents();
                    codeResetModal.classList.add('hidden');
                } else {
                    codeErrorMessage.classList.remove('hidden');
                    resetCodeInput.value = '';
                }
            });

            cancelCodeButton.addEventListener('click', () => {
                codeResetModal.classList.add('hidden');
            });

            closeInfoModalButton.addEventListener('click', () => {
                infoModal.classList.add('hidden');
            });

            viewAllHistoryButton.addEventListener('click', () => {
                allHistoryModal.classList.remove('hidden');
                renderChart();
            });

            closeAllHistoryModalButton.addEventListener('click', () => {
                allHistoryModal.classList.add('hidden');
            });

            currentDateEl.textContent = getFormattedDateString(new Date(), false);
            twoWeeksLaterDateEl.textContent = getReturnDate();

            loadData();
            renderStudents();
        });
    </script>
</body>
</html>

